# 2019-8-13 快投普通版+干预平台需求
## EnterpriseAccountController
1. 总行数：200.

```java
package com.sogou.bizdev.cpcassist.web.controller;

import  com.sogou.bizdev.cpcassist.web.utils.EnterpriseAccountUtil;
import  com.sogou.bizdev.cpcassist.web.utils.excel.ExportExcelUtil;
//省略。。。。

@Controller
@ControllerAdvice
@RequestMapping("/enterpriseaccount/")
public class EnterpriseAccountController extends BaseController {
	private static final Logger logger = LoggerFactory.getLogger(EnterpriseAccountController.class);

	@Autowired
	private FeedProvider feedProvider;

	// 主账户授权功能小流量
	private static final String MERCHANTCENTER_AUTHORIZE_ACCOUNT_SAMPLE = "merchantcenter_authorize_account_sample";

	/**
	 * 添加集团账户
	 * @param enterpriseAccountVo
	 * @return
	 * @throws BizException
	 */
	@RequestMapping(method = RequestMethod.POST, value = "createEnterpriseAccount.do")
	@ResponseBody
	public String createEnterpriseAccount(HttpServletRequest request, @RequestBody(required = false) EnterpriseAccountVo enterpriseAccountVo) throws BizException {
		//检查将插入的集团名称、账号ID跟数据库是否重复
		List<Long> accountIds = enterpriseAccountVo.getAccountIdList();
		String enterpriseName = enterpriseAccountVo.getEnterpriseAccountName();
		if (EnterpriseAccountUtil.findExistedEnterpriseIdsOrName(accountIds, enterpriseName, null, enterpriseAccountProvider)) {
			return sendAjaxFailed("该集团名称或账号集已存在，插入失败！");
		}
	}

	/**
	 * 修改集团账户名称
	 * @param enterpriseAccountVo
	 * @return
	 * @throws BizException
	 */
	@RequestMapping(method = RequestMethod.POST, value = "updateEnterpriseAccount.do")
	@ResponseBody
	public String updateEnterpriseAccount(HttpServletRequest request, @RequestBody(required = false) EnterpriseAccountVo enterpriseAccountVo) throws BizException {
		
		//检查将修改的集团名称、账号ID跟数据库是否存在重复
		List<Long> accountIds = enterpriseAccountVo.getAccountIdList();
		String enterpriseName = enterpriseAccountVo.getEnterpriseAccountName();
		if (EnterpriseAccountUtil.findExistedEnterpriseIdsOrName(accountIds, enterpriseName, enterpriseAccountVo, enterpriseAccountProvider)) {
			return sendAjaxFailed("该集团名称或账号集已存在，更新失败！");
		}
	}

	/**
	 * 批量添加集团账户（通过导入Excel文档）
	 * @param request
	 * @param file
	 * @return
	 * @throws Exception
	 */
	@RequestMapping(method = RequestMethod.POST, value = "batchAddEnterpriseAccount.do")
	@ResponseBody
	public String batchAddEnterpriseAccount(HttpServletRequest request, MultipartFile file) throws Exception {

		LoginUser loginUser = (LoginUser) request.getSession().getAttribute(CpcAssistConstants.SESSION_USER);

		if (file == null) {
			this.sendAjaxFailed("请上传文件");
		}
		if (StringUtils.isBlank(file.getOriginalFilename())	|| !file.getOriginalFilename().endsWith(".xlsx")) {
			this.sendAjaxFailed("文件类型不正确，目前只支持.xlsx");
		}

		//解析并处理文件，返回需要新增的集团账号列表，一个文档可能有多个集团
		List<EnterpriseAccountVo> enterpriseAccountVoList = ReadExcelUtil.readExcel(file);
		for (EnterpriseAccountVo enterpriseAccountVo : enterpriseAccountVoList) {
			//目前为了复用插入集团的接口，以一个集团为单位进行插入
			if (enterpriseAccountVo == null){
				return sendAjaxFailed(ErrorCode.getMsg(ErrorCode.ENTERPRISE_ACCOUNT_ISNULL));
			}
			//检查将插入的集团名称、账号ID跟数据库是否重复
			List<Long> accountIds = enterpriseAccountVo.getAccountIdList();
			String enterpriseName = enterpriseAccountVo.getEnterpriseAccountName();
			if (EnterpriseAccountUtil.findExistedEnterpriseIdsOrName(accountIds, enterpriseName, null, enterpriseAccountProvider)) {
				//该集团名称或账号集与数据库存在重复，插入失败，继续遍历下一个集团
				continue;
			}
			PlatformType platformType = PlatformType.parse(enterpriseAccountVo.getPlatformType());
			EnterpriseAccountDto enterPriseAccountDto = EnterpriseAccountConvertUtil.convertToEnterpriseAccountDto(enterpriseAccountVo);
			//创建账户
			enterpriseAccountProvider.createEnterpriseAccount(enterPriseAccountDto, null);

			//一些授权、小流量的操作
			if (CollectionUtils.isNotEmpty(enterPriseAccountDto.getAccountIdList())) {
				for (AccountSampleType type : AccountSampleType.values()) {
					permissionCheckProvider.addAccountListRole(new HashSet<>(enterPriseAccountDto.getAccountIdList()), type.getMemo());
				}
			}
			if (enterpriseAccountVo.getAssignAccountId() != null) {
				permissionCheckProvider.addAccountRole(enterpriseAccountVo.getAssignAccountId(), MERCHANTCENTER_AUTHORIZE_ACCOUNT_SAMPLE);
			}
			if (PlatformType.HIGH.equals(platformType)) {
				permissionCheckProvider.addAccountListRole(new HashSet<>(enterPriseAccountDto.getAccountIdList()), SkuConstants.KUAITOU_SKUSET_SAMPLE);
			}
			logger.info("user**********" + loginUser.getUserEmail() + "*****************createEnterpriseAccoun*************** enterpriseAccount is " + enterPriseAccountDto);
		}
		return sendAjaxNormal("");
	}

	/**
	 * 导出所有集团的账户信息（生成excel文档，信息导出到Excel文档中）
	 * @param request
	 * @param response
	 * @param enterpriseAccountName
	 * @param companyType
	 */
	@RequestMapping(method = RequestMethod.POST, value = "batchDownloadEnterpriseAccount.do")
	public void batchDownloadEnterpriseAccount(HttpServletRequest request, HttpServletResponse response,
			@RequestParam(required = false) String enterpriseAccountName,
			@RequestParam(required = false) Integer companyType) throws BizException, IOException {
		//获取全部集团账号信息；如果查询词为空，默认返回全部
		List<EnterpriseAccountDto> allDtoList = enterpriseAccountProvider.getEnterpriseAccountList(enterpriseAccountName, null);
		Map<Long, Integer> enterpriseIdToAccountLever = new HashMap<>();
		for (EnterpriseAccountDto enterpriseAccountDto : allDtoList) {
			if (enterpriseAccountDto != null && CollectionUtils.isNotEmpty(enterpriseAccountDto.getAccountIdList())) {
				Long accountId = enterpriseAccountDto.getAccountIdList().get(0);
				if (permissionCheckProvider.hasRole(accountId, SkuConstants.KUAITOU_SKUSET_SAMPLE)) {
					enterpriseIdToAccountLever.put(enterpriseAccountDto.getEnterpriseAccountId(), PlatformType.HIGH.getType());
				} else {
					enterpriseIdToAccountLever.put(enterpriseAccountDto.getEnterpriseAccountId(), PlatformType.COMMON.getType());
				}
			}
		}
		List<EnterpriseDto> enterpriseDto = EnterpriseAccountConvertUtil.convertToEnterPriseDtos(allDtoList, companyType, enterpriseIdToAccountLever);
		String sheetName = "快投集团账户列表";

		ByteArrayOutputStream out = new ByteArrayOutputStream();
		ExcelWriter excelWriter = EasyExcelFactory.getWriter(out);
		InputStream inputStream = null;
		try {
			Sheet sheet = new Sheet(CpcAssistConstants.SHEET_NUM, CpcAssistConstants.HEAD_LINE_NUM, ExportInfo.class, sheetName, null);
			//宽度自适应
			sheet.setAutoWidth(true);
			sheet.setTableStyle(ExportExcelUtil.getTableStyle());
			//将数据通过模型存到excel的写入流中
			excelWriter.write(ExportExcelUtil.createExportExcelMode(enterpriseDto), sheet);
			excelWriter.finish();
			EnterpriseAccountUtil.downLoadFileByFileBytes("《快投集团账户列表》", out.toByteArray(), response);
		} catch (Exception e) {
			e.printStackTrace();
			logger.error("Excel写入失败。");
		}finally {
			try {
				out.close();
			} catch (IOException e) {
				logger.error("输出流关闭失败。");
			}
			if (inputStream != null) {
				try {
					inputStream.close();
				} catch (IOException e) {
					logger.error("输入流关闭失败。");
				}
			}
		}
	}
}

```

## EnterpriseAccountUtil.java
1. 行数：119
```java
package com.sogou.bizdev.cpcassist.web.utils;

import com.sogou.bizdev.common.exception.BizException;
import com.sogou.bizdev.cpcassist.web.vo.EnterpriseAccountVo;
import com.sogou.bizdev.kuaitou.dto.EnterpriseAccountDto;
import com.sogou.bizdev.kuaitou.provider.EnterpriseAccountProvider;
import org.apache.commons.collections.CollectionUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.servlet.ServletOutputStream;
import javax.servlet.http.HttpServletResponse;
import java.nio.charset.StandardCharsets;
import java.util.*;

/**
 * @program: cpc-assist
 * @description: 集团账号增删改查所用的工具类
 * @create: 2019-08-12 20:42
 **/

public class EnterpriseAccountUtil {
    private static final Logger logger = LoggerFactory.getLogger(EnterpriseAccountUtil.class);

    /**
     * 下载文件，设置一些response信息
     *
     * @param fileName 文件名
     * @param bytes byte[]格式的文件内容
     */
    public static void downLoadFileByFileBytes(String fileName, byte[] bytes, HttpServletResponse response) throws Exception {

        fileName = response.encodeURL(new String(fileName.getBytes(StandardCharsets.UTF_8), "ISO-8859-1"));
        //转码
        response.setContentType("APPLICATION/OCTET-STREAM");
        response.setHeader("Content-Disposition", "attachment; filename=\"" + fileName + ".xlsx\"");
        ServletOutputStream outputStream = response.getOutputStream();
        //将其写入的输出流中
        if (bytes != null) {
            outputStream.write(bytes);
        }
        outputStream.flush();
        outputStream.close();
    }

    /**
     * 检查要插入的集团账号ID或者集团名称是否已存在数据库中，重复则报错，整个集团插入失败
     * @param accountIds
     * @param updateVo 如果不为null则需要传递一个EnterpriseAccountVo对象，表示更新操作，需要特殊处理:
     *                    因为其账号id或者集团名称，如果未完全修改，肯定跟数据库中的旧数据重复。
     * @return
     */
    public static boolean findExistedEnterpriseIdsOrName(List<Long> accountIds, String enterpriseName, EnterpriseAccountVo updateVo, EnterpriseAccountProvider enterpriseAccountProvider) throws BizException {
        //查找集团名称是否已存在，用的模糊匹配
        List<EnterpriseAccountDto> existedEnterpriseNameDtoList = enterpriseAccountProvider.getEnterpriseAccountList(enterpriseName, null);

        if (updateVo == null) {
            //查找是否存在重复账号ID
            List<EnterpriseAccountDto> existedAccountDtoList = enterpriseAccountProvider.queryEnterpriseAccountDtosByAccountIds(accountIds, null);
            if (CollectionUtils.isNotEmpty(existedAccountDtoList)) {
                logger.warn ("不可重复添加相同的账号ID，重复账号有：" + existedAccountDtoList.toString());
                return true;
            }
            if (CollectionUtils.isNotEmpty(existedEnterpriseNameDtoList)) {
                //将模糊匹配到的集团名称列出来，修改成精确匹配，
                Set<String> nameSet = new HashSet<>();
                for (EnterpriseAccountDto dto : existedEnterpriseNameDtoList) {
                    nameSet.add(dto.getEnterpriseAccountName());
                }
                if (nameSet.contains(enterpriseName)) {
                    logger.warn ("不可重复添加相同集团名称，重复集团名称为：" + enterpriseName);
                    return true;
                }
            }
        }else {
            Long enterpriseId = updateVo.getEnterpriseAccountId();
            //查出自身
            List<EnterpriseAccountDto> existedEnterpriseAccountDtos = enterpriseAccountProvider.getEnterpriseAccountList(Collections.singletonList(enterpriseId), null);
            if (CollectionUtils.isNotEmpty(existedEnterpriseAccountDtos)) {
                EnterpriseAccountDto myselfDto = existedEnterpriseAccountDtos.get(0);
                //将本身已存在数据库中的账号id，从要去查重的集合中将去除
                List<Long> newAccountIds = new ArrayList<>();
                newAccountIds.addAll(accountIds);
                newAccountIds.removeAll(myselfDto.getAccountIdList());
                if (CollectionUtils.isNotEmpty(newAccountIds)) {
                    List<EnterpriseAccountDto> existedAccountDtoList = enterpriseAccountProvider.queryEnterpriseAccountDtosByAccountIds(newAccountIds, null);
                    if (CollectionUtils.isNotEmpty(existedAccountDtoList)) {
                        logger.warn ("更新内容与其他已存在的账号ID重复。" );
                        return true;
                    }
                }

                //确认集团名称是否重名
                if (CollectionUtils.isNotEmpty(existedEnterpriseNameDtoList)) {
                    //从重复列表中将自身移除
                    Iterator<EnterpriseAccountDto> iterator = existedEnterpriseNameDtoList.iterator();
                    while (iterator.hasNext()) {
                        EnterpriseAccountDto dto = iterator.next();
                        if (dto.getEnterpriseAccountId().equals(updateVo.getEnterpriseAccountId())) {
                            iterator.remove();
                        }
                    }
                    //将模糊匹配到的集团名称列出来，修改成精确匹配，
                    Set<String> nameSet = new HashSet<>();
                    if (CollectionUtils.isNotEmpty(existedEnterpriseNameDtoList)) {
                        for (EnterpriseAccountDto dto : existedEnterpriseNameDtoList) {
                            nameSet.add(dto.getEnterpriseAccountName());
                        }
                        if (nameSet.contains(enterpriseName)) {
                            logger.warn ("集团名称已存在，重复集团名称为：" + enterpriseName);
                            return true;
                        }
                    }
                }
            }
        }
        return false;
    }
}

```

## Excel工具类：ReadExcellUtil + ExportExcelUtil
### Excel工具类：ReadExcellUtil
1. 227行
```java
package com.sogou.bizdev.cpcassist.web.utils.excel;

import com.alibaba.excel.EasyExcelFactory;
import com.alibaba.excel.metadata.Sheet;
import com.sogou.bizdev.cpcassist.constants.CpcAssistConstants;
import com.sogou.bizdev.cpcassist.web.vo.EnterpriseAccountVo;
import com.sogou.bizdev.kuaitou.constants.PlatformType;
import com.sogou.bizdev.merchantcenter.common.constants.CompanyType;
import com.sogou.demter.util.StringUtils;
import org.apache.commons.collections.CollectionUtils;
import org.apache.commons.lang3.math.NumberUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.util.*;

/**
 * @program: cpc-assist-kuaitou-normal-version
 * @description: 处理Excel
 * @author: ZhaoJinbo
 * @create: 2019-08-02 16:37
 **/
public class ReadExcelUtil {
    private static final Logger logger = LoggerFactory.getLogger(ReadExcelUtil.class);

    public static List<EnterpriseAccountVo> readExcel(MultipartFile file) throws IOException {
        List<Object> excelContents = EasyExcelFactory.read(file.getInputStream(), new Sheet(1));
        int lineNum = getRowsByContent(excelContents);
        //装载Excel表每行信息，进行相关处理，初始化大小；集团名称作为key
        Map<String, EnterpriseAccountVo> mapList = new HashMap<>(lineNum);

        //一行行处理校验
        List<String> rowContent = new ArrayList<>();
        EnterpriseAccountVo tempItem = new EnterpriseAccountVo();

        //信息不一致的集团需要全部放弃;所以用这个set存储出现不一致的集团，后续该集团的账户直接放弃。
        Set<String> errorEnterpriseSet = new HashSet<>();
        //这批数据出现的所有主账户ID，用于查重，保证集团和主账号一一对应，
        Set<Long> assignAccountIdsSet = new HashSet<>();
        //这批数据出现的所有账号ID，用于查重，保证账号只能在一个集团中
        Set<Long> accountIdsSet = new HashSet<>();
        for (int i = CpcAssistConstants.START_LINE; i < excelContents.size(); i++) {
            rowContent =(List<String>) excelContents.get(i);
            //首先对该行数据进行字段合法校验,合法就继续往下
            if (!verifyRowDatas(rowContent, i)){
                //不合法就丢弃该行数据，继续遍历下一行。
                continue;
            }
            Long accountId = Long.parseLong(rowContent.get(0));
            Long assignAccountId = Long.parseLong(rowContent.get(1));
            //集团名称作为map的key
            String enterpriseName = rowContent.get(2).trim();
            //厂商类型给的是中文String，需要转成Integer放到EnterpriseAccountVo中
            String companyTypeStr = rowContent.get(3);
            Integer companyType = CompanyType.parse(companyTypeStr).getType();
            //平台类型文档提供的也是中文，需要装成Integer
            String  platformTypeStr = rowContent.get(4);
            Integer platformType = PlatformType.parse(platformTypeStr).getType();
            //错误集团集合中包含该集团，说明该集团前面已经出现信息不一致情况，所以此条数据添加失败
            if (errorEnterpriseSet.contains(enterpriseName)) {
                logger.error("该集团下信息存在不一致，该集团账号全部添加失败。");
                continue;
            }
            //一个账号ID重复出现，以第一次插入的为准
            if (!(accountIdsSet.add(accountId))) {
                logger.error("该账户ID重复，请仔细检查。");
                continue;
            }
            if (mapList.containsKey(enterpriseName)) {
                //集团已添加，只需判断其他信息是否一致，若一致，则将该账号加到主账号下的集团
                tempItem = mapList.get(enterpriseName);
                //对比相同集团名称下的主账户ID/厂商类型是否一致,并且集团内账户ID不重复
                if (tempItem.getAssignAccountId().equals(assignAccountId) &&
                tempItem.getCompanyType().equals(companyType)) {
                    //增加一个账号到集团账号list中
                    List<Long> aList =  tempItem.getAccountIdList();
                    aList.add(accountId);
                    tempItem.setAccountIdList(aList);
                }else{
                    logger.error("该集团主账号/平台版本不一致，该集团账号全部添加失败。");
                    //信息不一致，无法判断该集团账户哪些信息是正确的，直接放弃添加该集团的所有账户
                    mapList.remove(enterpriseName);
                    errorEnterpriseSet.add(enterpriseName);
                    continue;
                }
            }else {
                //集团名第一次出现，新增一个集团账户
                EnterpriseAccountVo temp = new EnterpriseAccountVo();
                if (!assignAccountIdsSet.add(assignAccountId)){
                    //如果账号添加到集合失败，说明该账号之前已添加过，这次是重复添加
                    logger.error("一个账号或主账号只能属于一个集团");
                    continue;
                }
                temp.setEnterpriseAccountId(accountId);
                temp.setAssignAccountId(assignAccountId);
                temp.setEnterpriseAccountName(enterpriseName);
                temp.setCompanyType(companyType);
                List<Long> tempList =  new ArrayList<>();
                tempList.add(accountId);
                temp.setAccountIdList(tempList);
                //当前默认全部人工审核
                temp.setExemptReview(0);
                //平台版本：0代表普通版，1代表高级版。
                temp.setPlatformType(platformType);

                mapList.put(enterpriseName, temp);
            }
        }
        //然后把map中的value取出装到list中作为返回值
        List<EnterpriseAccountVo> reList = new ArrayList<>();
        for (EnterpriseAccountVo value : mapList.values()) {
            //校验下：主账号必须存在于集团账户ID列表中
            if (value.getAccountIdList().contains(value.getAssignAccountId())) {
                reList.add(value);
            }
        }
        return reList;
    }

    /**
     * 对一行数据进行校验，目前仅添加了非空校验
     * @param rowContent
     * @return
     */
    public static boolean verifyRowDatas(List<String> rowContent, int lineNum) {
        logger.info("第" + lineNum + "行数据：" + rowContent.toString());
        if (CollectionUtils.isNotEmpty(rowContent)) {
            //所有字段不允许为空，为空的该行数据无效
            //ID
            if (StringUtils.isBlank(rowContent.get(0))) {
                logger.error("ID不能为空，内容校验不通过" );
                return false;
            }else {
                if (!NumberUtils.isDigits(rowContent.get(0))) {
                    logger.error("ID必须为正整数，内容检验不通过");
                    return false;
                }
            }
            //主账号ID
            if (StringUtils.isBlank(rowContent.get(1))) {
                logger.error("主账号不能为空，内容校验不通过");
                return false;
            }else {
                if (!NumberUtils.isDigits(rowContent.get(1))) {
                    logger.error("主账号必须为正整数，内容检验不通过");
                    return false;
                }
            }
            //客户名称
            if (StringUtils.isBlank(rowContent.get(2))) {
                logger.error("客户名称不能为空，内容校验不通过");
                return false;
            }
            //厂商类型
            if (StringUtils.isBlank(rowContent.get(3))) {
                logger.error("厂商类型不能为空，内容校验不通过");
                return false;
            }else {
                //判断集团类型是否在集团类型列表中
                if (!isContain(rowContent.get(3), "CompanyType")){
                    logger.error("厂商类型不在类型列表中，内容校验不通过");
                    return false;
                }
            }
            //平台版本
            if (StringUtils.isBlank(rowContent.get(4))) {
                logger.error("平台版本不能为空，内容校验不通过");
                return false;
            }else {
                //判断平台版本是否在版本类型列表中
                if (!isContain(rowContent.get(4), "PlatformType")){
                    logger.error("平台版本不在版本列表中，内容校验不通过");
                    return false;
                }
            }
            return true;
        }else {
            logger.error("该行数据为空，内容校验不通过");
            return false;
        }

    }

    /**
     * 返回有多少行数据
     * @param contents
     * @return
     */
    public static int getRowsByContent(List<Object> contents) {
        int row = 0;
        for (Object content : contents) {
            List<String> datas = (List<String>) content;
            // 排除一行都是null的数据
            Set<String> uniqContents = new HashSet<>(datas);
            uniqContents.remove(null);
            if (uniqContents.size() > 0) {
                row++;
            }
        }
        return row;
    }

    /**
     * 将判断中文形式的类型是否存在于对应的枚举类中
     * @param inputType excel表格中传入中文形式的类型（集团类型或者平台版本）
     * @param enumType 枚举类型的种类（目前只有平台版本PlatformType、集团类型CompanyType）
     * @return
     */
    public static boolean isContain(String inputType, String enumType) {
        if (("PlatformType").equals(enumType)) {
            for (PlatformType value : PlatformType.values()) {
                if (value.getMemo().equals(inputType)) {
                    return true;
                }
            }
        } else if ("CompanyType".equals(enumType)) {
            for (CompanyType value : CompanyType.values()) {
                if (value.getMemo().equals(inputType)) {
                    return true;
                }
            }
        }
        return false;
    }
}

```

### Excel工具类-导出：ExportExcelUtil 
1. 79行
2. 代码
```java
package com.sogou.bizdev.cpcassist.web.utils.excel;

import com.alibaba.excel.metadata.Font;
import com.alibaba.excel.metadata.TableStyle;
import com.sogou.bizdev.cpcassist.web.dto.EnterpriseDto;
import org.apache.commons.lang.StringUtils;
import org.apache.poi.ss.usermodel.IndexedColors;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.ArrayList;
import java.util.List;


/**
 * @program: cpc-assist-kuaitou-normal-version
 * @description: Excel写入导出测试
 * @author: ZhaoJinbo
 * @create: 2019-07-31 15:42
 **/
public class ExportExcelUtil {
    private static Logger logger = LoggerFactory.getLogger(ExportExcelUtil.class);

    /**
     * 将数据装载到模板中，以便用于excel的写入
     * @param list
     * @return
     */
    public static List<ExportInfo> createExportExcelMode(List<EnterpriseDto> list) {
        List<ExportInfo> infos = new ArrayList<>();
        for (EnterpriseDto dto : list) {
            ExportInfo info = new ExportInfo();
            if (dto.getEnterPriseAccountId() != null) {
                info.setEnterpriseAccountId(dto.getEnterPriseAccountId());
            }
            if (StringUtils.isNotBlank(dto.getEnterPriseAccountName())) {
                info.setEnterpriseName(dto.getEnterPriseAccountName());
            }
            if (StringUtils.isNotBlank(dto.getCompanyTypeStr())) {
                info.setCompanyTypeStr(dto.getCompanyTypeStr());
            }
            if (dto.getAssignAccountId() != null) {
                info.setAssignAccountId(dto.getAssignAccountId());
            }
            if (StringUtils.isNotBlank(dto.getPlatformTypeStr())) {
                info.setPlatformType(dto.getPlatformTypeStr());
            }
            /** 集团账户展示（以;分隔） */
            if (StringUtils.isNotBlank(dto.getAccountIdStr())) {
                info.setAccountIdStr(dto.getAccountIdStr());
            }
            infos.add(info);
        }
        return infos;
    }

    /**
     * 设置表头和表格的字体格式和背景色
     * @return
     */
    public static TableStyle getTableStyle() {
        TableStyle tableStyle = new TableStyle();
        Font headFont = new Font();
        headFont.setBold(true);
        headFont.setFontHeightInPoints((short)14);
        headFont.setFontName("楷体");
        tableStyle.setTableHeadFont(headFont);

        Font contentFont = new Font();
        contentFont.setBold(false);
        contentFont.setFontHeightInPoints((short)12);
        contentFont.setFontName("黑体");
        tableStyle.setTableContentFont(contentFont);
        tableStyle.setTableContentBackGroundColor(IndexedColors.WHITE);
        return tableStyle;
    }


}

```

### 导出模板类：ExportInfo
1. 79行
2. 代码
```java
package com.sogou.bizdev.cpcassist.web.utils.excel;

import com.alibaba.excel.annotation.ExcelProperty;
import com.alibaba.excel.metadata.BaseRowModel;

/**
 * @program: cpc-assist-kuaitou-normal-version
 * @description: 导出表格模板
 * @author: ZhaoJinbo
 * @create: 2019-07-31 15:46
 **/
public class ExportInfo extends BaseRowModel {
    @ExcelProperty(index = 0,value = "集团ID")
    private long enterpriseAccountId;

    @ExcelProperty(index = 1,value = "集团名称")
    private String enterpriseName;

    @ExcelProperty(index = 2,value = "厂商类型")
    private String companyTypeStr;

    @ExcelProperty(index = 3,value = "平台版本")
    private String platformType;  //"高级版"和"普通版"

    @ExcelProperty(index = 4,value = "主账户")
    private long assignAccountId; //指定过审客户ID

    @ExcelProperty(index = 5,value = "账号ID列表")
    private String accountIdStr;

    public long getEnterpriseAccountId() {
        return enterpriseAccountId;
    }

    public void setEnterpriseAccountId(long enterpriseAccountId) {
        this.enterpriseAccountId = enterpriseAccountId;
    }

    public String getEnterpriseName() {
        return enterpriseName;
    }

    public void setEnterpriseName(String enterpriseName) {
        this.enterpriseName = enterpriseName;
    }

    public String getCompanyTypeStr() {
        return companyTypeStr;
    }

    public void setCompanyTypeStr(String companyTypeStr) {
        this.companyTypeStr = companyTypeStr;
    }

    public String getPlatformType() {
        return platformType;
    }

    public void setPlatformType(String platformType) {
        this.platformType = platformType;
    }

    public long getAssignAccountId() {
        return assignAccountId;
    }

    public void setAssignAccountId(long assignAccountId) {
        this.assignAccountId = assignAccountId;
    }

    public String getAccountIdStr() {
        return accountIdStr;
    }

    public void setAccountIdStr(String accountIdStr) {
        this.accountIdStr = accountIdStr;
    }
}

```

## 快投普通版
### 
1. 100
2. 代码
```java
@RequestMapping(method = RequestMethod.GET, value = "getIdeaTemplateFiledMap.action")
	@ResponseBody
	public void getIdeaTemplateFiledMap(SkuUnitParamVo cpcSkuUnitVo) throws Exception {
		LoginUser loginUser = LoginUserHelper.getCurrentUser();
		Long accountId = loginUser.getUserId();

		Map<String, Collection<IdeaTemplateParametersVo>> rtnMap = new HashMap<>();

		//文本字段
		Map<String, IdeaTemplateParametersVo> titleMap = new HashMap<>();
		//图片字段
		Map<String, IdeaTemplateParametersVo> imageMap = new HashMap<>();
		//数字字段
		Map<String, IdeaTemplateParametersVo> priceMap = new HashMap<>();
		//落地页字段
		Map<String, IdeaTemplateParametersVo> urlMap = new HashMap<>();

		Long feedId = cpcSkuUnitVo.getFeedId();
		FeedDto feedDto = feedProvider.queryFeedDtoByFeedId(feedId, null);
		if (feedDto == null) {
			this.sendAjaxFailed("找不到对应的feed！");
		}

		//获取模板规则
		List<FeedSchemaContentDto> feedSchemaContentDtoList = feedSchemaProvider.queryFeedSchemaDtosByDatastandard(feedDto.getDataStandard(), feedDto.getType(), null);
		//根据模板类型给出不同的字段结果。模板类型：0:excel 1:xml
		if (Objects.equals(feedDto.getType(), SchemaType.EXCEL.getType())
				&& CollectionUtils.isNotEmpty(feedSchemaContentDtoList)) {
			for (FeedSchemaContentDto dto : feedSchemaContentDtoList) {
				//根据字段属于哪一类，放到对应的map里面
				switch (getParamType(dto.getHeader())) {
					case "title":
						titleMap.put(dto.getHeader(), new IdeaTemplateParametersVo(dto.getHeader(), dto.getName()));
						break;
					case "image":
						imageMap.put(dto.getHeader(), new IdeaTemplateParametersVo(dto.getHeader(), dto.getName()));
						break;
					case "price":
						priceMap.put(dto.getHeader(), new IdeaTemplateParametersVo(dto.getHeader(), dto.getName()));
						break;
					case "url":
						urlMap.put(dto.getHeader(), new IdeaTemplateParametersVo(dto.getHeader(), dto.getName()));
						break;
					default:
						//其他默认都放在文本字段
						titleMap.put(dto.getHeader(), new IdeaTemplateParametersVo(dto.getHeader(), dto.getName()));
						break;
				}
			}
		}else {
			//xml模板，目前只有2种模板
			titleMap.put("name", new IdeaTemplateParametersVo("name", "商品名称"));
			titleMap.put("title", new IdeaTemplateParametersVo("title", "商品描述"));
			titleMap.put("brand", new IdeaTemplateParametersVo("brand", "产品品牌"));
			titleMap.put("model", new IdeaTemplateParametersVo("model", "商品型号"));
			titleMap.put("services", new IdeaTemplateParametersVo("services", "服务"));
			titleMap.put("tags", new IdeaTemplateParametersVo("tags", "标签"));
			titleMap.put("promotion", new IdeaTemplateParametersVo("promotion", "促销活动"));
			titleMap.put("feature", new IdeaTemplateParametersVo("feature", "特色"));

			imageMap.put("image", new IdeaTemplateParametersVo("image", "商品图片URL"));
			imageMap.put("image2", new IdeaTemplateParametersVo("image2", "商品备用图片URL"));

			priceMap.put("price", new IdeaTemplateParametersVo("price", "商品现价"));
			priceMap.put("value", new IdeaTemplateParametersVo("value", "商品原价"));
			priceMap.put("saving", new IdeaTemplateParametersVo("saving", "商品节省价格"));
			priceMap.put("stock", new IdeaTemplateParametersVo("stock", "库存量"));
			priceMap.put("bought", new IdeaTemplateParametersVo("bought", "已购买人数"));
			priceMap.put("promotion", new IdeaTemplateParametersVo("promotion", "促销活动/加盟金额（仅针对加盟、汽车等特殊行业，用于填写价格信息"));

			urlMap.put("loc", new IdeaTemplateParametersVo("loc", "商品移动端URL"));
			urlMap.put("pcLoc", new IdeaTemplateParametersVo("pcLoc", "商品PC端URL"));
			urlMap.put("logo", new IdeaTemplateParametersVo("logo", "商家logo网址"));
			urlMap.put("brandUrl", new IdeaTemplateParametersVo("brandUrl", "品牌页URL-移动端"));

			//根据淘宝厂商给出不同结果
			EnterpriseAccountDto enterpriseAccountDto = enterpriseAccountProvider.queryEnterpriseAccountDtoByAccountId(accountId, null);
			if (enterpriseAccountDto != null) {
				if (CompanyType.TAOBAO.getType()
						.equals(enterpriseAccountDto.getCompanyType())) {
					imageMap.remove("image");
					urlMap.put("tmallLoc", new IdeaTemplateParametersVo("tmallLoc", "商品移动端URL"));
					urlMap.put("tmallPcLoc", new IdeaTemplateParametersVo("tmallPcLoc", "商品PC端URL"));
					urlMap.put("taobaoLoc", new IdeaTemplateParametersVo("taobaoLoc", "商品移动端URL"));
					urlMap.put("taobaoPcLoc", new IdeaTemplateParametersVo("taobaoPcLoc", "商品PC端URL"));
				}else if (CompanyType.JINGDONG.getType()
						.equals(enterpriseAccountDto.getCompanyType())) {
					urlMap.put("pcBrandUrl", new IdeaTemplateParametersVo("pcBrandUrl", "品牌页URL-PC端"));
					urlMap.put("hotUrl", new IdeaTemplateParametersVo("HotUrl", "热卖页URL-移动端"));
					urlMap.put("pcHotUrl", new IdeaTemplateParametersVo("pcHotUrl", "热卖页URL-PC端"));

				}else if (CompanyType.ALIBABA.getType().equals(enterpriseAccountDto.getCompanyType())) {
					urlMap.put("kuaitouloc", new IdeaTemplateParametersVo("kuaitouloc", ""));
					urlMap.put("kuaitoupcloc", new IdeaTemplateParametersVo("kuaitoupcloc", ""));
				}
			}
		}

		rtnMap.put("title", titleMap.values());
		rtnMap.put("image", imageMap.values());
		rtnMap.put("price", priceMap.values());
		rtnMap.put("url", urlMap.values());
		sendAjaxNormal(JSONUtils.toJsonString(rtnMap));
	}

	/******************************私有方法*****************************/
	/**
	 * 获取字段属于哪一类List，当前共分了四种字段大类。当前是固定的映射，后期可用配置文件读取
	 * @param param
	 * @return
	 */
	public String getParamType(String param) {
		String type = "title";
		if (TITLE_SET.contains(param)) {
			type = "title";
		}else if (IMAGE_SET.contains(param)){
			type = "image";
		}else if (PRICE_SET.contains(param)){
			type = "price";
		}else if (URL_SET.contains(param)){
			type = "url";
		}
		return type;
	}

```

### IdeaTemplateParametersVo 创意模板设置界面的一些参数字段，中英文对照
1. 50行
```java
package com.sogou.bizdev.kuaitou.web.vo;

import java.io.Serializable;

/**
 * @program: kuaitou
 * @description: 创意模板设置界面的一些参数字段，中英文对照
 * @create: 2019-08-08 12:31
 **/
public class IdeaTemplateParametersVo implements Serializable{
	
	private static final long serialVersionUID = 965334096765448213L;
	//字段英文名
	private String header;
	//字段中文名
    private String name;

    public IdeaTemplateParametersVo() {
    }

    public IdeaTemplateParametersVo(String header, String name) {
        this.header = header;
        this.name = name;
    }

    public String getHeader() {
        return header;
    }

    public void setHeader(String header) {
        this.header = header;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    @Override
    public String toString() {
        return "IdeaTemplateParametersVo{" +
                "header='" + header + '\'' +
                ", name='" + name + '\'' +
                '}';
    }
}

```

### ToKuaitouReportUrlController 跳转到快投数据报告页
1. 90
2. 代码
```java
package com.sogou.bizdev.kuaitou.web.controller;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Controller;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;

import com.sogou.bizdev.kuaitou.platform.constants.DelegateConstants;
import com.sogou.bizdev.kuaitou.platform.dto.LoginUser;
import com.sogou.bizdev.kuaitou.platform.utils.LoginUserHelper;
import com.sogou.bizdev.kuaitou.platform.web.filter.SessionUserFilter;
import com.sogou.bizdev.utils.encrypt.EncryptUtils;
import com.sogou.business.constants.bizlog.BizLogConstants;

/**
 * @program: kuaitou
 * @description: 跳转到快投数据报告页
 * @create: 2019-08-09 11:43
 **/
@Controller
@Validated
@RequestMapping(value = "/index")
public class ToKuaitouReportUrlController extends BaseController {
    private static final String KEY = "j^#$vhDaksdh34ASDFERbdfgAS$%%@#423VDFSDFH%^$%#DFBertWE$%#$GNRT#$5@#$%GFUERTAFgsdfger78808klj,bvzmxcZBasdhfgaqwe5t3487dflvabserk23958fgssefwer==-e58737ufjneHHDGFywhjGJGJKHCKED8(hHGdhjdfJ#)(*^%#!@&(MJNHVffderyUVXCZXER";

    private static final Logger logger = LoggerFactory.getLogger(ToKuaitouReportUrlController.class);

    @RequestMapping(value="/toKuaitouReport.action")
    @ResponseBody
    public void toKuaitouReport(HttpServletRequest request, HttpServletResponse response) throws Exception {
        LoginUser currentUser = LoginUserHelper.getCurrentUser();
        Long uid = currentUser.getUserId();
        LoginUser sessionUser = ((LoginUser) request.getSession().getAttribute(SessionUserFilter.SESSION_XURI_USER));

        try {
            String adminUrl = DelegateConstants.adminUrl;
            String xuriUrl = DelegateConstants.xuriUrl;
            //跳转快投数据报的URL
            String redirecturl = xuriUrl + "/cpcadindex/init2.action#/datareport/kuaitou/list";
            String boUrl = DelegateConstants.boUrl;
            String adminType = "Admin";
            String agentType = "AgentUser";
            String accountManagerUrl = DelegateConstants.accountManagerUrl;
            String accountManagerType = "ManagerUser";

            if (currentUser.getOperationType().equals(BizLogConstants.EnumUserOperationType.ADMIN_P4P_OPERATION)) {// admin代管旭日 单独处理
                // 接入统一代管中心
                redirecturl = String.format(
                        "/delegate?userId=%d&targetUserId=%d&sourceService=%s&targetService=%s&proxyService=%s&delegateType=%s",
                        sessionUser.getCurrentUserId(), sessionUser.getUserId(), adminUrl, redirecturl,
                        xuriUrl, adminType);

            } else if (!currentUser.getOperationType().equals(BizLogConstants.EnumUserOperationType.P4P_OPERATION)
                    && !currentUser.getOperationType().equals(BizLogConstants.EnumUserOperationType.ACCOUNT_MANAGER_OPERATION)) {// agent代管
                //接入统一代管中心
                redirecturl = String.format(
                        "/delegate?userId=%d&targetUserId=%d&sourceService=%s&targetService=%s&proxyService=%s&suf_p4p_user_id=%d&delegateType=%s",
                        sessionUser.getAgent().getAgentUserId(), sessionUser.getUserId(), boUrl,
                        redirecturl, xuriUrl, sessionUser.getUserId(), agentType);

            }
            // 账户管家代管旭日跳
            else if (currentUser.getOperationType().equals(BizLogConstants.EnumUserOperationType.ACCOUNT_MANAGER_OPERATION)) {
                redirecturl = String.format(
                        "/delegate?userId=%d&targetUserId=%d&sourceService=%s&targetService=%s&proxyService=%s&suf_p4p_user_id=%d&delegateType=%s",
                        sessionUser.getAccountManagerUserId(), sessionUser.getUserId(),
                        accountManagerUrl, redirecturl, xuriUrl, sessionUser.getUserId(),
                        accountManagerType);
            } else {
                // If not use cas, then go through encrypt channel.
                if (DelegateConstants.useCas) {

                } else {
                    redirecturl = redirecturl + "/accountindex/atlasCommission.action?uid="
                            + EncryptUtils.desEncrypt("" + uid, KEY) + "&ct=" + (System.currentTimeMillis() / 1000);
                }
            }
//			redirecturl += "&type=" + lu.getOperationType().ordinal();
            logger.info("redirect to kuaitouReport: " + redirecturl);
            response.sendRedirect(redirecturl);

        } catch (Exception e) {
            logger.error("", e);
        }
    }
}

```