# 需求分析
## 需求MRD



# 熟悉代码

## Checkout代码 2019-8-15
单品样式报告主要涉及这几个系统
- atlas  报告页面 最近版本：7.319.0
  - http://bizsvn.sogou-inc.com/svn/atlas/trunk
- kuaitou-report  报告查询服务 最近版本：1.5.0
  - http://bizsvn.sogou-inc.com/svn/kuaitou-report/trunk
- xreport  API报告服务 最近版本：5.6.0
  - http://bizsvn.sogou-inc.com/svn/xreport/trunk
- ergate 报告数据生成任务  最近版本：1.396.0
  - http://bizsvn.sogou-inc.com/svn/ergate/trunk

## 连接数据库
- qa的 kuaitou报告 mong：
    - 10.153.52.191   kuaitoureport01.mongodb
    - 10.153.54.239   kuaitoureport02.mongodb
    - 10.153.61.232   kuaitoureport03.mongodb
- 端口和账号密码可以看代码的配置文件 qa-配置文件
- #dev
10.134.96.212    xuriopt01.mongodb
10.134.98.143    xuriopt02.mongodb
10.134.101.163   xuriopt03.mongodb

- kuaitou-report
10.145.71.197
root	bizdev_xuri1! 开发机部署

进入resin配置文件，找到kuaitou-report的webapp目录，将war包放进去解压，然后重启resin：
重启resin需要进入其bin目录，然后` ./resin.sh stop/start`,需要授权就输入`chmod +x resin.sh`.

- 如何传数据到开发机，可以使用putty自带的pscp命令：
```shell
pscp 文件 用户名@LinuxIP:目录
```
- 使用“ -r ”选项可以用于传输目录。
```
基本命令格式：pscp  -r 目录 用户名@LinuxIP:目录
或使用命令格式：pscp -l 用户名 -r 目录 LinuxIP:目录
```
- 然后`unzip kuaitouxxx.war`
- 然后重启resin
- 查看是否重启成功：`ps -ef | grep resin`

### 问题解决
1. 微服务授权，可以改名字，该对应配置文件，保持统一就可以了。
2. kuaitou-report是发布rmi服务，通过上传war到开发机上，解压后用resin启动，提供微服务，在微服务平台上注册服务，提供服务。
3. 客户端进行服务使用，需要授权ip。
4. atlas启动还需要对数据库进行host配置，让host与ip进行对应。 端口密码需要相对修改，看情况。
5. 启动后发现没有内容，系统繁忙，账号为空。 看了微服务配置，检查一遍。发现是resin配置的账号id在开发环境没有，换一个就行了

## 现有系统功能、界面熟悉
- 登录地址：数字从无到12，貌似都可以试试。
    - http://qa数字.docker.xuri.p4p.sogou/cpcadindex/init2.action#/index
- 测试账号1-2月份有报告数据：
    - shctrip@sogou.com
    - 密码，测试账号都是8个2.
- 快投有数据的小流量用户账号：
  - 20283157
  - 18924990
- notify-public、finance、iflow-api、galaxywireless-api服务挂了


# 代码编写
## kuaitou-report
1. 查询PIC_LIST，等并列的字段，找到修改点。 

## 功能分析
1. 快投这边三个接口
2. atlas这边，两个controller，一个展示一个下载，不过主要都是修改过滤器验证器、
3. 

## 代码逻辑设计

## 启动遇到的各种问题
### 数据库相关问题
1. mongodb
   cpcmongodb分库分表：
分库分表计算  输入aid
2. mongodb查询示例：
```sql
db.planreport.aggregate(
    [
        {$match:{"mid":{$gte:"8692164_201901010000"},"mid":{$lt:"8692164_201901030000"}}},
        {$group:{_id:"aid",num_tutorial:{$sum:"$cm"}}}
    ]
)
```

### 坑
- 测试Test程序，测试API功能时，复用老的代码，手贱把一个参数注释掉了，谁知道那个参数是关键，还查不到报错。
- 通过实例化进行测试没进容器，调用的类中的注入可能为null，应该用其他办法。
- 服务可能直接调用远程的，要测试一下。
- 发布服务:
  - 打包java里面的com成为com.zip
  - 然后上传到微服务平台：
    - 接口管理-文件管理-切到RMI-导入-选择appid（
      - 这里需要提前创建：服务治理-增加appidkuaitoureport-zjb-然后业务网把本地的/开发机的ip填上，OK。）
  - 然后在 服务治理-使用者-切换到 权限管理-申请权限：提供者appid选择刚刚创建的那个，使用者就用自己以前的或者新建都行，接口全选，然后确认。
  - 申请权限后还需要授权，也是在服务治理-使用者-切换到 权限管理-全选申请的方法，然后点击右侧的批量审核，审核通过。 这里一般只能审核通过自己上传的服务吧？
  - wifi状态ip变成了：10.129.32.36。微服务无法调用。